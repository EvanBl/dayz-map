<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ World Map (Dynmap tiles)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .leaflet-container { background:#0b0f14; }

    #status, #hud {
      position: fixed;
      left: 10px;
      z-index: 9999;
      padding: 8px 10px;
      border-radius: 10px;
      color: #fff;
      font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      pointer-events: none;
      background: rgba(0,0,0,.65);
      max-width: 85vw;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #status { top: 10px; background:#2e7d32; }
    #hud { bottom: 10px; }
    #hud b { color:#8bc34a; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status">booting…</div>
  <div id="hud">loading…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ========= CONFIG ========= */
    const WORLD = "world";
    const VIEW  = "ne";
    const BASE_URL = "https://pub-83eb0b1759804463a95053e4b8319ef5.r2.dev/"; // MUST end with /

    const EXT = "jpg";
    const TILE_PX = 128;
    const TILES_PER_DIR = 32;

    // Leaflet zoom 6 = Dynmap zoomOut 0 (most detailed)
    // Leaflet zoom 0 = Dynmap zoomOut 6 (most zoomed out)
    const LEAFLET_MAX_Z = 6;
    const LEAFLET_MIN_Z = 0;
    const START_Z = 6;

    const BLANK = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

    /* ========= HELPERS ========= */
    function withSlash(s){ return s.endsWith("/") ? s : (s + "/"); }
    const BASE = withSlash(BASE_URL);

    function floorDiv(n, d){
      if (n >= 0) return Math.floor(n / d);
      const q = Math.trunc(n / d);
      return (q * d === n) ? q : (q - 1);
    }
    function bucket(t){ return floorDiv(t, TILES_PER_DIR); }

    function zoomPrefix(zoomOut){
      if (zoomOut <= 0) return "";
      return "z".repeat(zoomOut) + "_";
    }

    function dynUrl(tx, ty, zoomOut){
      const bx = bucket(tx);
      const by = bucket(ty);
      const pref = zoomPrefix(zoomOut);
      return `${BASE}tiles/${WORLD}/${VIEW}/${bx}_${by}/${pref}${tx}_${ty}.${EXT}`;
    }

    /* ========= LEAFLET ========= */
    const map = L.map("map", {
      crs: L.CRS.Simple,
      minZoom: LEAFLET_MIN_Z,
      maxZoom: LEAFLET_MAX_Z,
      zoomSnap: 1,
      zoomControl: true
    });

    const DynmapLayer = L.TileLayer.extend({
      getTileUrl: function(coords) {
        // Leaflet z=6 -> zoomOut 0, z=5 -> zoomOut 1, ..., z=0 -> zoomOut 6
        const zoomOut = (LEAFLET_MAX_Z - coords.z);

        // KEY FIX:
        // Dynmap zoomOut tiles exist only on a grid step of 2^zoomOut.
        // So we must scale coords by that step (otherwise you request tons of non-existent tiles).
        const step = 1 << zoomOut;

        const tx = coords.x * step;
        const ty = -(coords.y * step); // Dynmap flips Y in filename space

        return dynUrl(tx, ty, zoomOut) + `?v=${Date.now()}`;
      }
    });

    new DynmapLayer("", {
      tileSize: TILE_PX,
      noWrap: true,
      keepBuffer: 8,
      updateWhenIdle: true,
      errorTileUrl: BLANK
    }).addTo(map);

    map.setView([0, 0], START_Z);

    const status = document.getElementById("status");
    status.textContent =
      `OK\nworld:${WORLD}\nview:${VIEW}\nEXT:${EXT}\nTILE:${TILE_PX}px\nLeaflet z:${START_Z} (zoomOut 0)`;

    const hud = document.getElementById("hud");
    function updateHUD(){
      const z = map.getZoom();
      const zoomOut = LEAFLET_MAX_Z - z;
      const step = 1 << zoomOut;

      const c = map.getCenter();
      // Show *which dynmap tile* the center is sampling at this zoom level
      const cx = Math.floor(c.lng / TILE_PX);
      const cy = Math.floor(c.lat / TILE_PX);

      const tx = cx * step;
      const ty = -(cy * step);

      hud.innerHTML =
        `leaflet z=<b>${z}</b> | dynmap zoomOut=<b>${zoomOut}</b> | step=<b>${step}</b>\n` +
        `center lat=<b>${c.lat.toFixed(2)}</b> lng=<b>${c.lng.toFixed(2)}</b>\n` +
        `dyn tile @center: <b>${tx}_${ty}</b>\n` +
        `sample:\n${dynUrl(tx, ty, zoomOut)}`;
    }
    map.on("move zoom", updateHUD);
    updateHUD();
  </script>
</body>
</html>
