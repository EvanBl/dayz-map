<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ World Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- disable caching while testing -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .leaflet-container { background:#0b0f14; }

    #hud, #status {
      position: fixed;
      left: 10px;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 10px;
      color: #fff;
      font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      pointer-events: none;
      background: rgba(0,0,0,.6);
      max-width: 85vw;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #status { top: 10px; background:#2e7d32; }
    #hud { bottom: 10px; }
    #hud b { color:#8bc34a; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status">booting…</div>
  <div id="hud">loading…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  /* ================= CONFIG ================= */

  // Dynmap folder structure:
  // {BASE}/tiles/{WORLD}/{VIEW}/{bx_by}/{tile}.jpg
  const WORLD = "world";
  const VIEW  = "ne";  // dynmap prefix
  const BASE_URL = "https://pub-83eb0b1759804463a95053e4b8319ef5.r2.dev/";

  // Confirmed by your overlay
  const EXT = "jpg";
  const TILE_PX = 128;

  // Your renderer: base tile represents 32x32 blocks
  const BLOCKS_PER_TILE = 32;

  // Bucket dirs are 32 tiles wide: e.g. -11_-5 contains tx [-352..-321]
  const TILES_PER_DIR = 32;

  // Leaflet zoom config
  // Dynmap zoom-outs exist up to 6 => allow Leaflet -6..2
  const MIN_ZOOM   = -6;
  const MAX_ZOOM   =  2;
  const START_ZOOM = -6;

  const BLANK = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

  /* ================= HELPERS ================= */

  function withSlash(s){ return s.endsWith("/") ? s : (s + "/"); }
  const BASE = withSlash(BASE_URL);

  // Correct floor division for negatives
  function floorDiv(n, d){
    if (n >= 0) return Math.floor(n / d);
    const q = Math.trunc(n / d);
    return (q * d === n) ? q : (q - 1);
  }

  // bucket folder index in "base tile units" (NOT zoomed units)
  const bucket = (t) => floorDiv(t, TILES_PER_DIR);

  // Dynmap zoom-out filename prefixes:
  // zoomOut 0 => ""         =>  tx_ty.jpg
  // zoomOut 1 => "z_"       =>  z_tx_ty.jpg
  // zoomOut 2 => "zz_"      =>  zz_tx_ty.jpg
  // ...
  function zoomPrefix(zoomOut){
    return zoomOut <= 0 ? "" : ("z".repeat(zoomOut) + "_");
  }

  /**
   * THE KEY FIX:
   * Dynmap zoom-out tiles are stored on a grid where tx/ty are multiples of 2^zoomOut.
   * Example you showed:
   *   zoomOut 5 => zzzzz_-384_-448.jpg  (-384 and -448 are multiples of 32 = 2^5)
   *
   * Leaflet's coords.x/coords.y at zoom z=-zoomOut correspond to "zoomed grid tiles".
   * To address Dynmap files, we must convert:
   *   dynTx = coords.x * 2^zoomOut
   *   dynTy = coords.y * 2^zoomOut
   *
   * (This keeps (0,0) anchored correctly across all zoomOut levels.)
   */
  function dynTileCoords(coords){
    const tileZ = coords.z;

    // For zoom-in (z>0), we don't have dynmap zoom-in pyramids.
    // We'll clamp native requests to z=0 later via maxNativeZoom:0.
    // So here, treat >0 as 0.
    const effZ = Math.min(tileZ, 0);

    const zoomOut = Math.max(0, -effZ);
    const mul = 1 << zoomOut; // 2^zoomOut

    const tx = coords.x * mul;
    const ty = coords.y * mul;

    return { tx, ty, zoomOut };
  }

  function dynTileUrl(tx, ty, zoomOut){
    const bx = bucket(tx);
    const by = bucket(ty);
    const pref = zoomPrefix(zoomOut);
    return `${BASE}tiles/${WORLD}/${VIEW}/${bx}_${by}/${pref}${tx}_${ty}.${EXT}`;
  }

  /* ================= MAP SETUP ================= */

  // CRS units = z0 pixels. Convert CRS pixels -> blocks:
  const pxPerBlock = TILE_PX / BLOCKS_PER_TILE;

  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: MIN_ZOOM,
    maxZoom: MAX_ZOOM,
    zoomSnap: 1,
    updateWhenZooming: false,
    zoomControl: true
  });

  const DynmapLayer = L.TileLayer.extend({
    getTileUrl: function(coords){
      const { tx, ty, zoomOut } = dynTileCoords(coords);
      return dynTileUrl(tx, ty, zoomOut);
    }
  });

  // NOTE:
  // maxNativeZoom:0 => for Leaflet zoom > 0, it keeps requesting z0 tiles and scales them.
  // That is correct because Dynmap doesn't generate zoom-in tile pyramids.
  new DynmapLayer("", {
    tileSize: TILE_PX,
    maxNativeZoom: 0,
    noWrap: false,           // don't clamp; let it request negative tiles too
    keepBuffer: 16,
    updateWhenZooming: false,
    updateWhenIdle: true,
    errorTileUrl: BLANK
  }).addTo(map);

  // Start zoomed all the way out at origin (0,0)
  map.setView([0, 0], START_ZOOM);

  document.getElementById("status").textContent =
    `OK\nworld:${WORLD}\nview:${VIEW}\next:${EXT}\ntile:${TILE_PX}px\norigin anchored at (0,0)\nzoomOut tiles enabled`;

  /* ================= HUD ================= */

  const hud = document.getElementById("hud");

  function updateHUD(latlng){
    const zLeaf = map.getZoom();
    const zoomOut = Math.max(0, -zLeaf);

    const xBlocks = latlng.lng / pxPerBlock;
    const zBlocks = latlng.lat / pxPerBlock;

    hud.innerHTML =
      `X:<b>${xBlocks.toFixed(1)}</b> Z:<b>${zBlocks.toFixed(1)}</b>` +
      ` | leaflet z=<b>${zLeaf}</b> | zoomOut:<b>${zoomOut}</b>`;
  }

  map.on("mousemove", e => updateHUD(e.latlng));
  map.on("click", e => {
    updateHUD(e.latlng);
    const x = Math.floor(e.latlng.lng / pxPerBlock);
    const z = Math.floor(e.latlng.lat / pxPerBlock);
    navigator.clipboard?.writeText(`${x} ${z}`);
  });

  /* ================= OPTIONAL PROBE ================= */
  (function probe(){
    // probe a couple tiles at different zoomOut levels near origin
    const samples = [
      { zoomOut: 0, tx: 0, ty: 0 },
      { zoomOut: 1, tx: 0, ty: 0 },
      { zoomOut: 2, tx: 0, ty: 0 },
      { zoomOut: 3, tx: 0, ty: 0 },
    ];
    samples.forEach(s => {
      const url = dynTileUrl(s.tx, s.ty, s.zoomOut) + `?t=${Date.now()}`;
      const img = new Image();
      img.onload = () => console.log("Probe OK:", url);
      img.onerror = () => console.warn("Probe failed:", url);
      img.src = url;
    });
  })();
  </script>
</body>
</html>
