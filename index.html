<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ World Map (Dynmap tiles)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .leaflet-container { background:#0b0f14; }

    #status, #hud {
      position: fixed;
      left: 10px;
      z-index: 9999;
      padding: 8px 10px;
      border-radius: 10px;
      color: #fff;
      font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      pointer-events: none;
      background: rgba(0,0,0,.65);
      max-width: 85vw;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #status { top: 10px; background:#2e7d32; }
    #hud { bottom: 10px; }
    #hud b { color:#8bc34a; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status">booting…</div>
  <div id="hud">loading…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ========= CONFIG ========= */
    const WORLD = "world";
    const VIEW  = "ne";

    // MUST end with /
    const BASE_URL = "https://pub-83eb0b1759804463a95053e4b8319ef5.r2.dev/";

    // Dynmap tiles are bucketed in 32x32 directories: bx_by/
    const TILES_PER_DIR = 32;

    // Dynmap tile pixel size (almost always 128)
    const TILE_PX = 128;

    // Dynmap provides zoom-out tiles as: z_, zz_, zzz_, ...
    // We'll use Leaflet zooms: 0 (native), -1..-6 (zoomOut 1..6)
    const MIN_ZOOM = -6;
    const MAX_ZOOM = 0;
    const START_ZOOM = -1; // start slightly zoomed out so you immediately test zoomOut

    const BLANK = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

    /* ========= HELPERS ========= */
    function withSlash(s){ return s.endsWith("/") ? s : (s + "/"); }
    const BASE = withSlash(BASE_URL);

    function floorDiv(n, d){
      // true floor division for negatives
      if (n >= 0) return Math.floor(n / d);
      const q = Math.trunc(n / d);
      return (q * d === n) ? q : (q - 1);
    }

    function bucket(t){ return floorDiv(t, TILES_PER_DIR); }

    function zoomPrefix(zoomOut){
      if (zoomOut <= 0) return "";
      return "z".repeat(zoomOut) + "_";
    }

    function dynUrl(tx, ty, zoomOut){
      const bx = bucket(tx);
      const by = bucket(ty);
      const pref = zoomPrefix(zoomOut);
      // NOTE: this exactly matches your R2 structure: tiles/world/ne/bx_by/[z.._]x_y.jpg
      return `${BASE}tiles/${WORLD}/${VIEW}/${bx}_${by}/${pref}${tx}_${ty}.jpg`;
    }

    /* ========= LEAFLET ========= */
    const map = L.map("map", {
      crs: L.CRS.Simple,
      minZoom: MIN_ZOOM,
      maxZoom: MAX_ZOOM,
      zoomSnap: 1,
      zoomControl: true
    });

    const DynmapLayer = L.TileLayer.extend({
      getTileUrl: function(coords) {
        // Leaflet zoom 0 = native dynmap tiles (no prefix)
        // Leaflet zoom -N = dynmap zoomOut N (z_, zz_, ...)
        const zoomOut = Math.max(0, -coords.z);

        // IMPORTANT:
        // Treat Leaflet tile coords as Dynmap tile coords.
        // Let Leaflet’s TMS option handle the Y inversion.
        const tx = coords.x;
        const ty = coords.y;

        return dynUrl(tx, ty, zoomOut);
      }
    });

    const layer = new DynmapLayer("", {
      tileSize: TILE_PX,
      // This is the big fix for “bands / shuffled strips” on iso maps:
      // Dynmap’s tile Y direction is opposite Leaflet default.
      tms: true,

      noWrap: true,
      keepBuffer: 8,
      updateWhenIdle: true,
      errorTileUrl: BLANK,

      // zooming in above 0 should just scale native tiles (Dynmap doesn’t have + zoom levels)
      maxNativeZoom: 0
    }).addTo(map);

    // Start at (0,0) tile-space. You can pan to wherever your content is.
    map.setView([0, 0], START_ZOOM);

    document.getElementById("status").textContent =
      `OK\nworld:${WORLD}\nview:${VIEW}\nTILE:${TILE_PX}px\nLeaflet z: ${START_ZOOM}\nDynmap zoomOut: ${Math.max(0, -START_ZOOM)}\n(tms:true)`;

    const hud = document.getElementById("hud");
    function updateHUD(){
      const z = map.getZoom();
      const zoomOut = Math.max(0, -z);
      const center = map.getCenter();
      hud.innerHTML =
        `leaflet z=<b>${z}</b> | zoomOut=<b>${zoomOut}</b>\n` +
        `center lat=<b>${center.lat.toFixed(2)}</b> lng=<b>${center.lng.toFixed(2)}</b>\n` +
        `tile sample URL:\n${dynUrl(0,0,zoomOut)}`;
    }
    map.on("move zoom", updateHUD);
    updateHUD();
  </script>
</body>
</html>
