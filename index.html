<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ World Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .leaflet-container { background:#0b0f14; }

    #status {
      position: fixed;
      left: 10px;
      top: 10px;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 8px;
      color: #fff;
      font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: rgba(0,0,0,.6);
      white-space: pre;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="status">bootingâ€¦</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  /* ====== CONFIG ====== */
  const WORLD = "world";
  const VIEW  = "ne";
  const BASE  = "https://pub-83eb0b1759804463a95053e4b8319ef5.r2.dev/"; // must end with /
  const EXT   = "jpg";
  const TILE_PX = 128;

  const BLOCKS_PER_TILE = 32;
  const TILES_PER_DIR   = 32;

  // your visibilitylimits (blocks)
  const X_MIN = -2640, X_MAX = 2720;
  const Z_MIN = -2720, Z_MAX = 5536;

  // use ONLY non-negative Leaflet zoom
  const LEAFLET_MIN_Z = 0;  // zoomOut=6
  const LEAFLET_MAX_Z = 6;  // zoomOut=0
  const START_Z       = 0;  // start fully zoomed-out (zoomOut=6)

  const BLANK = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

  function floorDiv(n, d){
    if (n >= 0) return Math.floor(n / d);
    const q = Math.trunc(n / d);
    return (q * d === n) ? q : (q - 1);
  }
  const tileX0 = (x) => floorDiv(x, BLOCKS_PER_TILE);
  const tileY0 = (z) => floorDiv(z, BLOCKS_PER_TILE);
  const bucket = (t) => floorDiv(t, TILES_PER_DIR);

  function zoomPrefix(zoomOut){
    return zoomOut <= 0 ? "" : ("z".repeat(zoomOut) + "_");
  }

  function dynUrl(tx, ty, zoomOut){
    const bx = bucket(tx), by = bucket(ty);
    const pref = zoomPrefix(zoomOut);
    return `${BASE}tiles/${WORLD}/${VIEW}/${bx}_${by}/${pref}${tx}_${ty}.${EXT}`;
  }

  // z0 tile bounds
  const MIN_TX0 = tileX0(X_MIN);
  const MAX_TX0 = tileX0(X_MAX - 1);
  const MIN_TY0 = tileY0(Z_MIN);
  const MAX_TY0 = tileY0(Z_MAX - 1);

  const W0 = (MAX_TX0 - MIN_TX0 + 1);
  const H0 = (MAX_TY0 - MIN_TY0 + 1);

  // CRS.Simple: [lat, lng] ~ [y, x], origin top-left
  const bounds = L.latLngBounds([0,0], [H0 * TILE_PX, W0 * TILE_PX]);

  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: LEAFLET_MIN_Z,
    maxZoom: LEAFLET_MAX_Z,
    zoomSnap: 1,
    zoomControl: true
  });

  const DynLayer = L.TileLayer.extend({
    getTileUrl: function(coords){
      // coords.z is 0..6 (non-negative)
      const zoomOut = LEAFLET_MAX_Z - coords.z; // 6..0

      const scale = 1 << zoomOut; // 64..1

      const MIN_TX = floorDiv(MIN_TX0, scale);
      const MAX_TX = floorDiv(MAX_TX0, scale);
      const MIN_TY = floorDiv(MIN_TY0, scale);
      const MAX_TY = floorDiv(MAX_TY0, scale);

      const tx = MIN_TX + coords.x;
      const ty = MIN_TY + coords.y;

      if (tx < MIN_TX || tx > MAX_TX || ty < MIN_TY || ty > MAX_TY) return BLANK;

      return dynUrl(tx, ty, zoomOut) + `?t=${Date.now()}`;
    }
  });

  new DynLayer("", {
    tileSize: TILE_PX,
    noWrap: true,
    keepBuffer: 8,
    updateWhenIdle: true,
    errorTileUrl: BLANK
  }).addTo(map);

  map.fitBounds(bounds);
  map.setZoom(START_Z);

  document.getElementById("status").textContent =
    `OK\nleaflet z: ${LEAFLET_MIN_Z}..${LEAFLET_MAX_Z}\nzoomOut: 6..0\n${BASE}tiles/${WORLD}/${VIEW}/...`;

  </script>
</body>
</html>
