<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DayZ World Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- hard disable caching while testing -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #0b0f14;
    }

    #hud {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 8px;
      background: rgba(0,0,0,.6);
      color: #fff;
      font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      pointer-events: none;
    }

    #hud b { color: #8bc34a; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="hud">loading…</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>

<script>
/* ================= CONFIG ================= */

// Dynmap world + map name (MUST match Dynmap `name:`)
const WORLD = "world";
const MAP   = "iso_NE_30_hires";

// Cloudflare R2 public base URL (must end with /)
const BASE_URL = "https://pub-5406e95e9e584f748be162ed018ae7fc.r2.dev/";

// Dynmap constants
const BLOCKS_PER_TILE = 128;   // z0 blocks per tile (Dynmap default)
const TILES_PER_DIR   = 32;    // tiles per bucket folder

// Your Dynmap visibility limits (blocks)
const X_MIN = -2640;
const X_MAX =  2720;
const Z_MIN = -2720;
const Z_MAX =  5536;

// blank tile
const BLANK = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

/* ================= HELPERS ================= */

function floorDiv(n, d) {
  if (n >= 0) return Math.floor(n / d);
  const q = Math.trunc(n / d);
  return (q * d === n) ? q : q - 1;
}

// block → tile index
const tileX = (x) => floorDiv(x, BLOCKS_PER_TILE);
const tileY = (z) => floorDiv(z, BLOCKS_PER_TILE);

// tile → bucket folder
const bucket = (t) => floorDiv(t, TILES_PER_DIR);

/* ================= DERIVED BOUNDS ================= */

const MIN_TX = tileX(X_MIN);
const MAX_TX = tileX(X_MAX - 1);
const MIN_TY = tileY(Z_MIN);
const MAX_TY = tileY(Z_MAX - 1);

const TILES_W = MAX_TX - MIN_TX + 1;
const TILES_H = MAX_TY - MIN_TY + 1;

/* ================= LEAFLET MAP ================= */

const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -6,
  maxZoom: 2,
  zoomSnap: 1,
  zoomControl: true,
  updateWhenZooming: false
});

// bounds in pixels at z0
const TILE_PX = 128; // dynmap tile pixel size
const bounds = L.latLngBounds(
  [-(TILES_H * TILE_PX), 0],
  [0, (TILES_W * TILE_PX)]
);

// custom tile layer
const DynmapLayer = L.TileLayer.extend({
  getTileUrl: function (coords) {
    const tx = MIN_TX + coords.x;
    const ty = MAX_TY - coords.y; // flip Y for dynmap grid

    if (tx < MIN_TX || tx > MAX_TX || ty < MIN_TY || ty > MAX_TY)
      return BLANK;

    const bx = bucket(tx);
    const by = bucket(ty);

    return (
      BASE_URL +
      `tiles/${WORLD}/${MAP}/${bx}_${by}/${tx}_${ty}.png`
    );
  }
});

new DynmapLayer("", {
  tileSize: TILE_PX,
  minNativeZoom: 0,
  maxNativeZoom: 0,
  noWrap: true,
  bounds: bounds,
  keepBuffer: 6,
  errorTileUrl: BLANK
}).addTo(map);

map.setMaxBounds(bounds);
map.options.maxBoundsViscosity = 1.0;
map.fitBounds(bounds.pad(0.12));

/* ================= HUD ================= */

const hud = document.getElementById("hud");
const PX_PER_BLOCK = TILE_PX / BLOCKS_PER_TILE;

map.on("mousemove", (e) => {
  const z = map.getZoom();
  const p = map.project(e.latlng, z);

  // normalize to z0 pixels
  const px0 = p.x * Math.pow(2, -z);
  const py0 = p.y * Math.pow(2, -z);

  const X = (px0 / PX_PER_BLOCK) + (MIN_TX * BLOCKS_PER_TILE);
  const Z = (py0 / PX_PER_BLOCK) + (MIN_TY * BLOCKS_PER_TILE);

  const tx = MIN_TX + Math.floor(px0 / TILE_PX);
  const ty = MAX_TY - Math.floor(py0 / TILE_PX);

  hud.innerHTML =
    `X:<b>${X.toFixed(1)}</b> Z:<b>${Z.toFixed(1)}</b>` +
    ` | tile:<b>${tx}_${ty}</b>` +
    ` | z=${z}`;
});

console.log("Dynmap viewer ready", {
  WORLD, MAP,
  MIN_TX, MAX_TX, MIN_TY, MAX_TY
});
</script>

</body>
</html>
